#!/usr/bin/env just --justfile
# ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì •

namespace := 'n8n'
manifests_dir := 'manifests'

# ë„ì›€ë§ í‘œì‹œ
_default:
    @just --list

# ============================================================
# ì„¤ì¹˜ ë° ì œê±°
# ============================================================

# n8n ì „ì²´ ì„¤ì¹˜ (PostgreSQL + n8n)
install:
    @echo "ğŸš€ n8n ì„¤ì¹˜ ì‹œì‘..."
    @echo ""
    @echo "1ï¸âƒ£  Namespace ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/namespace.yaml
    @echo ""
    @echo "3ï¸âƒ£  PostgreSQL ConfigMap ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/postgres-configmap.yaml
    @echo ""
    @echo ""
    @echo "3ï¸âƒ£  PostgreSQL ConfigMap ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/postgres-secret.yaml
    @echo ""
    @echo "4ï¸âƒ£  PostgreSQL PVC ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/postgres-pvc.yaml
    @echo "â³ PVC ìƒì„± ëŒ€ê¸° (5ì´ˆ)..."
    sleep 5
    @echo ""
    @echo "5ï¸âƒ£  PostgreSQL Deployment ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/postgres-deployment.yaml
    @echo ""
    @echo "6ï¸âƒ£  PostgreSQL Service ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/postgres-service.yaml
    @echo "â³ PostgreSQL ì‹œì‘ ëŒ€ê¸° (30ì´ˆ)..."
    sleep 30
    @echo ""
    @echo "7ï¸âƒ£  n8n PVC ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/n8n-pvc.yaml
    @echo "â³ PVC ìƒì„± ëŒ€ê¸° (5ì´ˆ)..."
    sleep 5
    @echo ""
    @echo "8ï¸âƒ£  n8n Deployment ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/n8n-deployment.yaml
    @echo ""
    @echo "9ï¸âƒ£  n8n Service ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/n8n-service.yaml
    @echo ""
    @echo "ğŸ”Ÿ n8n Ingress ìƒì„±..."
    kubectl apply -f {{ manifests_dir }}/n8n-ingress.yaml
    @echo ""
    @echo "âœ… n8n ì„¤ì¹˜ ì™„ë£Œ!"
    @echo ""
    @echo "ğŸ“Š ìƒíƒœ í™•ì¸: just status"
    @echo "ğŸŒ Ingress ì ‘ì†: http://n8n.moseoh.com"
    @echo "ğŸŒ ë¡œì»¬ ì ‘ì†: just port-forward"

# n8n ì „ì²´ ì‚­ì œ
uninstall:
    @echo "ğŸ—‘ï¸  n8n ì‚­ì œ ì‹œì‘..."
    kubectl delete -f {{ manifests_dir }}/n8n-ingress.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/n8n-service.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/n8n-deployment.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/n8n-pvc.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/postgres-service.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/postgres-deployment.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/postgres-pvc.yaml --ignore-not-found=true
    kubectl delete -f {{ manifests_dir }}/postgres-configmap.yaml --ignore-not-found=true
    kubectl delete secret postgres-secret -n {{ namespace }} --ignore-not-found=true
    kubectl delete namespace {{ namespace }} --ignore-not-found=true
    @echo "âœ… n8n ì‚­ì œ ì™„ë£Œ!"

# ì¬ì„¤ì¹˜ (ì‚­ì œ í›„ ì„¤ì¹˜)
reinstall: uninstall
    @echo "â³ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ëŒ€ê¸° (10ì´ˆ)..."
    sleep 10
    just install

# ============================================================
# ìƒíƒœ í™•ì¸
# ============================================================

# n8n ì „ì²´ ìƒíƒœ í™•ì¸
status:
    @echo "=== Namespace ==="
    kubectl get namespace {{ namespace }} 2>/dev/null || echo "âŒ Namespace not found"
    @echo ""
    @echo "=== PostgreSQL Resources ==="
    kubectl get deployment,service,pvc -n {{ namespace }} -l app=postgres 2>/dev/null || echo "âŒ PostgreSQL resources not found"
    @echo ""
    @echo "=== n8n Resources ==="
    kubectl get deployment,service,pvc -n {{ namespace }} -l app=n8n 2>/dev/null || echo "âŒ n8n resources not found"
    @echo ""
    @echo "=== Ingress ==="
    kubectl get ingress -n {{ namespace }} 2>/dev/null || echo "âŒ Ingress not found"
    @echo ""
    @echo "=== All Pods ==="
    kubectl get pods -n {{ namespace }} -o wide

# PostgreSQL ìƒíƒœ í™•ì¸
status-postgres:
    @echo "=== PostgreSQL Status ==="
    kubectl get deployment,service,pvc,pods -n {{ namespace }} -l app=postgres

# n8n ìƒíƒœ í™•ì¸
status-n8n:
    @echo "=== n8n Status ==="
    kubectl get deployment,service,pvc,pods -n {{ namespace }} -l app=n8n

# ============================================================
# ë¡œê·¸ í™•ì¸
# ============================================================

# n8n ë¡œê·¸ í™•ì¸
logs:
    kubectl logs -n {{ namespace }} -l app=n8n --tail=50 -f

# PostgreSQL ë¡œê·¸ í™•ì¸
logs-postgres:
    kubectl logs -n {{ namespace }} -l app=postgres --tail=50 -f

# ëª¨ë“  Pod ë¡œê·¸ í™•ì¸
logs-all:
    kubectl logs -n {{ namespace }} --all-containers=true --tail=50 -f

# ============================================================
# ì ‘ì† ë° ê´€ë¦¬
# ============================================================

# n8n í¬íŠ¸ í¬ì›Œë”© (ë¡œì»¬ ì ‘ì†ìš©)
port-forward:
    @echo "ğŸŒ n8n í¬íŠ¸ í¬ì›Œë”© ì‹œì‘..."
    @echo "ì ‘ì† URL: http://localhost:5678"
    kubectl port-forward -n {{ namespace }} svc/n8n 5678:80

# n8n í¬íŠ¸ í¬ì›Œë”© ëŒ€ì²´ (Pod ì§ì ‘)
port-forward-pod:
    @echo "ğŸŒ n8n Pod í¬íŠ¸ í¬ì›Œë”© ì‹œì‘..."
    @echo "ì ‘ì† URL: http://localhost:5678"
    kubectl port-forward -n {{ namespace }} deployment/n8n 5678:5678

# PostgreSQL í¬íŠ¸ í¬ì›Œë”© (ë””ë²„ê¹…ìš©)
port-forward-postgres:
    @echo "ğŸ—„ï¸  PostgreSQL í¬íŠ¸ í¬ì›Œë”© ì‹œì‘..."
    @echo "ì ‘ì†: psql -h localhost -p 5432 -U n8n n8n"
    kubectl port-forward -n {{ namespace }} svc/postgres 5432:5432

# n8n Podì— Shell ì ‘ì†
shell:
    kubectl exec -it -n {{ namespace }} deployment/n8n -- /bin/sh

# PostgreSQL Podì— Shell ì ‘ì†
shell-postgres:
    kubectl exec -it -n {{ namespace }} deployment/postgres -- /bin/bash

# ============================================================
# ì„¤ì • ê´€ë¦¬
# ============================================================

# Secret í™•ì¸ (base64 ë””ì½”ë”©)
show-secrets:
    @echo "=== PostgreSQL Secrets ==="
    kubectl get secret postgres-secret -n {{ namespace }} -o jsonpath='{.data.POSTGRES_PASSWORD}' | base64 -d
    @echo ""

# ConfigMap í™•ì¸
show-configmap:
    @echo "=== PostgreSQL ConfigMap ==="
    kubectl get configmap postgres-configmap -n {{ namespace }} -o yaml

# ============================================================
# ë¬¸ì œ í•´ê²°
# ============================================================

# Pod ì¬ì‹œì‘
restart:
    @echo "ğŸ”„ n8n Pod ì¬ì‹œì‘..."
    kubectl rollout restart deployment/n8n -n {{ namespace }}
    @echo "âœ… ì¬ì‹œì‘ ì™„ë£Œ! ìƒíƒœ í™•ì¸: just status"

# PostgreSQL Pod ì¬ì‹œì‘
restart-postgres:
    @echo "ğŸ”„ PostgreSQL Pod ì¬ì‹œì‘..."
    kubectl rollout restart deployment/postgres -n {{ namespace }}
    @echo "âœ… ì¬ì‹œì‘ ì™„ë£Œ! ìƒíƒœ í™•ì¸: just status-postgres"

# Pod ì´ë²¤íŠ¸ í™•ì¸
events:
    kubectl get events -n {{ namespace }} --sort-by='.lastTimestamp'

# Pod describe (ìƒì„¸ ì •ë³´)
describe:
    @echo "=== n8n Deployment ==="
    kubectl describe deployment n8n -n {{ namespace }}
    @echo ""
    @echo "=== n8n Pods ==="
    kubectl describe pods -n {{ namespace }} -l app=n8n
