#!/usr/bin/env just --justfile

# Homelab ì „ì²´ ì›Œí¬í”Œë¡œìš° ê´€ë¦¬
# ì‚¬ìš©ë²•: just <command>

# ë„ì›€ë§ í‘œì‹œ
default:
    @just --list

# ============================================================
# ê¸°ëŠ¥ë³„ ì›Œí¬í”Œë¡œìš° (ì¶”ì²œ)
# ============================================================

# ğŸ  ì „ì²´ í™ˆë© í™˜ê²½ êµ¬ì¶• (ìˆœì°¨ ì‹¤í–‰)
[group('ì›Œí¬í”Œë¡œìš°')]
setup-all: setup-base setup-storage setup-k3s setup-monitoring
    @echo "ğŸ‰ ì „ì²´ í™ˆë© í™˜ê²½ êµ¬ì¶• ì™„ë£Œ!"
    @echo ""
    @echo "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”:"
    @echo "  just status-all"

# ğŸ§ ê¸°ë³¸ ì„œë²„ ì„¤ì • (Ubuntu + WakeOnLAN)
[group('ì›Œí¬í”Œë¡œìš°')]
setup-base:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "ğŸ§ ê¸°ë³¸ ì„œë²„ ì„¤ì • ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd ansible && just run-ubuntu-setup
    cd ansible && just run-wakeonlan
    @echo "âœ… ê¸°ë³¸ ì„œë²„ ì„¤ì • ì™„ë£Œ!"

# ğŸ“ ìŠ¤í† ë¦¬ì§€ ì„¤ì • (NFS Server + Provisioner)
[group('ì›Œí¬í”Œë¡œìš°')]
setup-storage:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "ğŸ“ ìŠ¤í† ë¦¬ì§€ ì„¤ì • ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd ansible && just run-nfs-server
    @echo "â³ NFS ì„œë²„ ì‹œì‘ ëŒ€ê¸° (10ì´ˆ)..."
    sleep 10
    cd kubernetes && just install-nfs
    @echo "âœ… ìŠ¤í† ë¦¬ì§€ ì„¤ì • ì™„ë£Œ!"

# â˜¸ï¸  K3s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜
[group('ì›Œí¬í”Œë¡œìš°')]
setup-k3s:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "â˜¸ï¸  K3s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd ansible && just run-k3s
    @echo "â³ K3s í´ëŸ¬ìŠ¤í„° ì‹œì‘ ëŒ€ê¸° (30ì´ˆ)..."
    sleep 30
    @echo "âœ… K3s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ì™„ë£Œ!"

# ğŸ“Š ëª¨ë‹ˆí„°ë§ ì„¤ì • (SigNoz)
[group('ì›Œí¬í”Œë¡œìš°')]
setup-monitoring:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ì„¤ì • ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd kubernetes && just install-signoz
    @echo "âœ… ëª¨ë‹ˆí„°ë§ ì„¤ì • ì™„ë£Œ!"

# ğŸ¤– Kubeflow ì„¤ì¹˜
[group('ì›Œí¬í”Œë¡œìš°')]
setup-kubeflow:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "ğŸ¤– Kubeflow ì„¤ì¹˜ ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd kubernetes && just install-kubeflow
    @echo "âœ… Kubeflow ì„¤ì¹˜ ì™„ë£Œ!"

# âš¡ n8n ì›Œí¬í”Œë¡œìš° ìë™í™” ì„¤ì¹˜
[group('ì›Œí¬í”Œë¡œìš°')]
setup-n8n:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "âš¡ n8n ì„¤ì¹˜ ì‹œì‘..."
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cd kubernetes && just install-n8n
    @echo "âœ… n8n ì„¤ì¹˜ ì™„ë£Œ!"

# ============================================================
# ìƒíƒœ í™•ì¸
# ============================================================

# ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
[group('ìƒíƒœí™•ì¸')]
status-all:
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo "ğŸ“Š ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ"
    @echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    @echo ""
    @echo "=== Ansible ì—°ê²° í…ŒìŠ¤íŠ¸ ==="
    cd ansible && just ping || echo "âŒ Ansible ì—°ê²° ì‹¤íŒ¨"
    @echo ""
    @echo "=== Kubernetes í´ëŸ¬ìŠ¤í„° ==="
    kubectl cluster-info || echo "âŒ K3s í´ëŸ¬ìŠ¤í„° ì—°ê²° ì‹¤íŒ¨"
    @echo ""
    cd kubernetes && just status-all

# Ansible ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸
[group('ìƒíƒœí™•ì¸')]
ping:
    cd ansible && just ping

# Kubernetes ë¦¬ì†ŒìŠ¤ ìƒíƒœ
[group('ìƒíƒœí™•ì¸')]
k8s-status:
    cd kubernetes && just status-all

# Helm releases ìƒíƒœ
[group('ìƒíƒœí™•ì¸')]
helm-status:
    cd kubernetes && just helm-list

# ============================================================
# í•˜ìœ„ ëª¨ë“ˆ ì ‘ê·¼
# ============================================================

# Ansible ì„¸ë¶€ ì‘ì—…
mod ansible 'ansible'

# Kubernetes ì„¸ë¶€ ì‘ì—…
mod kubernetes 'kubernetes'

# ============================================================
# ìœ í‹¸ë¦¬í‹°
# ============================================================

# Vault íŒ¨ìŠ¤ì›Œë“œ ìƒì„± (ìµœì´ˆ 1íšŒ)
[group('ìœ í‹¸ë¦¬í‹°')]
init-vault:
    @echo "ğŸ” Vault íŒ¨ìŠ¤ì›Œë“œ ì´ˆê¸°í™”..."
    cd ansible && just vault-create-pass

# Vault í¸ì§‘
[group('ìœ í‹¸ë¦¬í‹°')]
vault-edit:
    cd ansible && just vault-edit

# Vault í™•ì¸
[group('ìœ í‹¸ë¦¬í‹°')]
vault-view:
    cd ansible && just vault-view

# í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸
[group('ìœ í‹¸ë¦¬í‹°')]
tree:
    @echo "ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°"
    @echo ""
    @echo "homelab/"
    @echo "â”œâ”€â”€ ansible/              # Ansible playbooks"
    @echo "â”‚   â”œâ”€â”€ playbooks/"
    @echo "â”‚   â”‚   â”œâ”€â”€ server/       # Ubuntu Server ê´€ë ¨"
    @echo "â”‚   â”‚   â”œâ”€â”€ kubernetes/   # K8s í´ëŸ¬ìŠ¤í„° ì„¤ì •"
    @echo "â”‚   â”‚   â””â”€â”€ common/       # ê³µí†µ (ì•Œë¦¼ ë“±)"
    @echo "â”‚   â””â”€â”€ Justfile         # Ansible ì„¸ë¶€ ì‘ì—…"
    @echo "â””â”€â”€ kubernetes/           # Kubernetes ë¦¬ì†ŒìŠ¤"
    @echo "    â”œâ”€â”€ infrastructure/   # ì¸í”„ë¼ (NFS ë“±)"
    @echo "    â”œâ”€â”€ applications/     # ì• í”Œë¦¬ì¼€ì´ì…˜"
    @echo "    â””â”€â”€ Justfile         # K8s ì„¸ë¶€ ì‘ì—…"
