#!/usr/bin/env just --justfile

# 기본 변수 설정
namespace := 'signoz'

# 도움말 표시
_default:
    @just --list

# SigNoz 설치
install:
    helm repo add signoz https://charts.signoz.io
    helm repo update
    helm upgrade --install signoz signoz/signoz \
        --namespace {{namespace}} \
        --create-namespace \
        --wait \
        --timeout 1h \
        -f signoz-values.yaml
    helm upgrade --install k8s-infra signoz/k8s-infra \
        --namespace {{namespace}} \
        --wait \
        --timeout 30m \
        -f signoz-k8s-values.yaml
    kubectl apply -f ingress.yaml --namespace {{namespace}}

# SigNoz 업데이트
update:
    helm repo update
    helm upgrade signoz signoz/signoz \
        --namespace {{namespace}} \
        -f signoz-values.yaml
    helm upgrade k8s-infra signoz/k8s-infra \
        --namespace {{namespace}} \
        -f signoz-k8s-values.yaml

# 상태 확인
status:
    @echo "=== Helm Releases ==="
    helm list -n {{namespace}}
    @echo "\n=== Pods ==="
    kubectl get pods -n {{namespace}} -o wide
    @echo "\n=== Services ==="
    kubectl get svc -n {{namespace}}
    @echo "\n=== Ingress ==="
    kubectl get ingress -n {{namespace}}
    @echo "\n=== DaemonSets ==="
    kubectl get daemonset -n {{namespace}}

# 로그 확인 (사용법: just logs signoz-frontend)
logs service:
    kubectl logs -n {{namespace}} -l app.kubernetes.io/name={{service}} --tail=50 -f

# SigNoz 메인 로그 확인
logs-main:
    kubectl logs -n {{namespace}} -l app.kubernetes.io/name=signoz --tail=50 -f

# K8s 인프라 로그 확인
logs-k8s:
    kubectl logs -n {{namespace}} -l app.kubernetes.io/name=k8s-infra --tail=50 -f

# 포트 포워딩 (로컬 접속용)
port-forward:
    kubectl port-forward -n {{namespace}} svc/signoz 28080:8080

# Values 파일 검증
validate:
    @echo "Validating signoz-values.yaml..."
    helm install signoz signoz/signoz \
        --namespace {{namespace}} \
        --dry-run \
        --debug \
        -f signoz-values.yaml | head -50
    @echo "\nValidating signoz-k8s-values.yaml..."
    helm install k8s-infra signoz/k8s-infra \
        --namespace {{namespace}} \
        --dry-run \
        --debug \
        -f signoz-k8s-values.yaml | head -50

# 현재 설치된 values 확인
get-values:
    helm get values signoz --namespace {{namespace}}
    helm get values k8s-infra --namespace {{namespace}}

# 재설치 (삭제 후 설치)
reinstall: uninstall install
    @echo "SigNoz reinstalled successfully"

# 삭제
uninstall:
    kubectl delete -f ingress.yaml --ignore-not-found=true
    helm uninstall k8s-infra --namespace {{namespace}} || true
    helm uninstall signoz --namespace {{namespace}} || true
    kubectl delete namespace {{namespace}} --ignore-not-found=true

# Helm 차트 버전 확인
check-version:
    @echo "=== Current installed versions ==="
    helm list -n {{namespace}} || echo "Not installed"
    @echo "\n=== Available SigNoz versions ==="
    helm search repo signoz/signoz --versions | head -10
    @echo "\n=== Available K8s-infra versions ==="
    helm search repo signoz/k8s-infra --versions | head -10