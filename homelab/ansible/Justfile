# Homelab Ansible ìë™í™”
# ì‚¬ìš©ë²•: just <command>

vault_file := ".vault_pass"
inventory := "inventory/hosts.yml"
ansible := "uv run ansible"
ansible_playbook := "uv run ansible-playbook"

# ë„ì›€ë§ í‘œì‹œ
default:
    @just --list

# ============================================================
# ì—°ê²° í…ŒìŠ¤íŠ¸
# ============================================================

[group('ì—°ê²°')]
ping:
    @echo "ğŸ  í™ˆë© ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸..."
    {{ ansible }} homelab -i {{ inventory }} -m ping --vault-password-file {{ vault_file }}

# ============================================================
# Server í”Œë ˆì´ë¶
# ============================================================

# Ubuntu ì„œë²„ ì´ˆê¸° ì„¤ì • ì‹¤í–‰
[group('Server')]
run-ubuntu-setup:
    @echo "ğŸ§ Ubuntu ì„œë²„ ì´ˆê¸° ì„¤ì • ì‹¤í–‰..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/ubuntu-setup.yml --vault-password-file {{ vault_file }}

# WakeOnLAN ì„¤ì • ì‹¤í–‰
[group('Server')]
run-wakeonlan:
    @echo "âš¡ WakeOnLAN ì„¤ì • ì‹¤í–‰..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/wakeonlan-setup.yml --vault-password-file {{ vault_file }}

# NFS ì„œë²„ ì„¤ì • ì‹¤í–‰
[group('Server')]
run-nfs-server:
    @echo "ğŸ“ NFS ì„œë²„ ì„¤ì • ì‹¤í–‰..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/nfs-server-setup.yml --vault-password-file {{ vault_file }}

# Ubuntu ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
[group('Server')]
check-ubuntu-setup:
    @echo "ğŸ” Ubuntu ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/ubuntu-setup.yml --vault-password-file {{ vault_file }} --check || echo "âœ… í™•ì¸ ì™„ë£Œ (ë³€ê²½ ì‚¬í•­ ê°ì§€ëŠ” ì •ìƒ)"

# WakeOnLAN ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
[group('Server')]
check-wakeonlan:
    @echo "ğŸ” WakeOnLAN ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/wakeonlan-setup.yml --vault-password-file {{ vault_file }} --check || echo "âœ… í™•ì¸ ì™„ë£Œ (ë³€ê²½ ì‚¬í•­ ê°ì§€ëŠ” ì •ìƒ)"

# NFS ì„œë²„ ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
[group('Server')]
check-nfs-server:
    @echo "ğŸ” NFS ì„œë²„ ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/server/nfs-server-setup.yml --vault-password-file {{ vault_file }} --check || echo "âœ… í™•ì¸ ì™„ë£Œ (ë³€ê²½ ì‚¬í•­ ê°ì§€ëŠ” ì •ìƒ)"

# ============================================================
# Kubernetes í”Œë ˆì´ë¶
# ============================================================

# K3s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ì‹¤í–‰
[group('Kubernetes')]
run-k3s:
    @echo "â˜¸ï¸ K3s í´ëŸ¬ìŠ¤í„° ì„¤ì¹˜ ì‹¤í–‰..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/kubernetes/k3s-setup.yml --vault-password-file {{ vault_file }}

# K3s í´ëŸ¬ìŠ¤í„° ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
[group('Kubernetes')]
check-k3s:
    @echo "ğŸ” K3s í´ëŸ¬ìŠ¤í„° ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/kubernetes/k3s-setup.yml --vault-password-file {{ vault_file }} --check || echo "âœ… í™•ì¸ ì™„ë£Œ (ë³€ê²½ ì‚¬í•­ ê°ì§€ëŠ” ì •ìƒ)"

# ============================================================
# Common í”Œë ˆì´ë¶
# ============================================================

# Slack ì•Œë¦¼ ì „ì†¡ ì‹¤í–‰
[group('Common')]
run-slack-alert:
    @echo "ğŸ’¬ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤í–‰..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/common/slack-alert.yml --vault-password-file {{ vault_file }}

# Slack ì•Œë¦¼ ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸
[group('Common')]
check-slack-alert:
    @echo "ğŸ” Slack ì•Œë¦¼ ì„¤ì • ë³€ê²½ ì‚¬í•­ í™•ì¸..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/common/slack-alert.yml --vault-password-file {{ vault_file }} --check || echo "âœ… í™•ì¸ ì™„ë£Œ (ë³€ê²½ ì‚¬í•­ ê°ì§€ëŠ” ì •ìƒ)"

# ============================================================
# Vault ê´€ë¦¬
# ============================================================

# Vault íŒŒì¼ ì•ˆì „ í¸ì§‘
[group('Vault')]
vault-edit:
    @echo "ğŸ” Vault íŒŒì¼ í¸ì§‘..."
    uv run ansible-vault edit inventory/group_vars/all/vault.yml --vault-password-file {{ vault_file }}

# Vault íŒŒì¼ ë‚´ìš© í™•ì¸
[group('Vault')]
vault-view:
    @echo "ğŸ‘ï¸ Vault íŒŒì¼ ë‚´ìš© í™•ì¸..."
    uv run ansible-vault view inventory/group_vars/all/vault.yml --vault-password-file {{ vault_file }}

# Vault íŒ¨ìŠ¤ì›Œë“œ íŒŒì¼ ìƒì„±
[group('Vault')]
vault-create-pass:
    @echo "ğŸ”‘ Vault íŒ¨ìŠ¤ì›Œë“œ íŒŒì¼ ìƒì„±..."
    @echo "íŒ¨ìŠ¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”:"
    @read -s password && echo "$$password" > {{ vault_file }}
    @chmod 600 {{ vault_file }}
    @echo "âœ… Vault íŒ¨ìŠ¤ì›Œë“œ íŒŒì¼ ìƒì„± ì™„ë£Œ: {{ vault_file }}"

# ============================================================
# ì •ë³´ í™•ì¸
# ============================================================

# ì¸ë²¤í† ë¦¬ í˜¸ìŠ¤íŠ¸ ëª©ë¡ (ê¸°ë³¸ ì •ë³´ë§Œ)
[group('ì •ë³´')]
inventory-list:
    @echo "ğŸ“‹ ì¸ë²¤í† ë¦¬ í˜¸ìŠ¤íŠ¸ ëª©ë¡..."
    uv run ansible-inventory --list -i {{ inventory }}
