# Homelab Ansible 자동화
# 사용법: just <command>

vault_file := ".vault_pass"
inventory := "inventory/hosts.yml"
ansible := "uv run ansible"
ansible_playbook := "uv run ansible-playbook"

# 도움말 표시
default:
    @just --list

# 연결 테스트
[group('연결')]
ping:
    @echo "🏠 홈랩 서버 연결 테스트..."
    {{ ansible }} homelab -i {{ inventory }} -m ping --vault-password-file {{ vault_file }}

# Ubuntu 서버 초기 설정 실행
[group('실행')]
run-ubuntu-setup:
    @echo "🐧 Ubuntu 서버 초기 설정 실행..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/ubuntu-setup.yml --vault-password-file {{ vault_file }}

# WakeOnLAN 설정 실행
[group('실행')]
run-wakeonlan:
    @echo "⚡ WakeOnLAN 설정 실행..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/wakeonlan-setup.yml --vault-password-file {{ vault_file }}

# NFS 서버 설정 실행
[group('실행')]
run-nfs-server:
    @echo "📁 NFS 서버 설정 실행..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/nfs-server-setup.yml --vault-password-file {{ vault_file }}

# K3s 클러스터 설치 실행
[group('실행')]
run-k3s:
    @echo "☸️ K3s 클러스터 설치 실행..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/k3s-setup.yml --vault-password-file {{ vault_file }}

# Slack 알림 전송 실행
[group('실행')]
run-slack-alert:
    @echo "💬 Slack 알림 전송 실행..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/slack-alert.yml --vault-password-file {{ vault_file }}

# 전체 홈랩 설치 실행 (순차 실행)
[group('실행')]
run-all: run-ubuntu-setup run-wakeonlan run-nfs-server run-k3s
    @echo "✅ 홈랩 전체 설치 완료!"

# Ubuntu 설정 변경 사항 확인
[group('확인')]
check-ubuntu-setup:
    @echo "🔍 Ubuntu 설정 변경 사항 확인..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/ubuntu-setup.yml --vault-password-file {{ vault_file }} --check || echo "✅ 확인 완료 (변경 사항 감지는 정상)"

# WakeOnLAN 설정 변경 사항 확인
[group('확인')]
check-wakeonlan:
    @echo "🔍 WakeOnLAN 설정 변경 사항 확인..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/wakeonlan-setup.yml --vault-password-file {{ vault_file }} --check || echo "✅ 확인 완료 (변경 사항 감지는 정상)"

# NFS 서버 설정 변경 사항 확인
[group('확인')]
check-nfs-server:
    @echo "🔍 NFS 서버 설정 변경 사항 확인..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/nfs-server-setup.yml --vault-password-file {{ vault_file }} --check || echo "✅ 확인 완료 (변경 사항 감지는 정상)"

# K3s 클러스터 설정 변경 사항 확인
[group('확인')]
check-k3s:
    @echo "🔍 K3s 클러스터 설정 변경 사항 확인..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/k3s-setup.yml --vault-password-file {{ vault_file }} --check || echo "✅ 확인 완료 (변경 사항 감지는 정상)"

# Slack 알림 설정 변경 사항 확인
[group('확인')]
check-slack-alert:
    @echo "🔍 Slack 알림 설정 변경 사항 확인..."
    {{ ansible_playbook }} -i {{ inventory }} playbooks/slack-alert.yml --vault-password-file {{ vault_file }} --check || echo "✅ 확인 완료 (변경 사항 감지는 정상)"

# 모든 플레이북 변경 사항 확인
[group('확인')]
check-all: check-ubuntu-setup check-wakeonlan check-nfs-server check-k3s
    @echo "✅ 모든 플레이북 확인 완료!"

# Vault 파일 안전 편집
[group('vault')]
vault-edit:
    @echo "🔐 Vault 파일 편집..."
    uv run ansible-vault edit inventory/group_vars/all/vault.yml --vault-password-file {{ vault_file }}

# Vault 파일 내용 확인
[group('vault')]
vault-view:
    @echo "👁️ Vault 파일 내용 확인..."
    uv run ansible-vault view inventory/group_vars/all/vault.yml --vault-password-file {{ vault_file }}

# Vault 패스워드 파일 생성
[group('vault')]
vault-create-pass:
    @echo "🔑 Vault 패스워드 파일 생성..."
    @echo "패스워드를 입력하세요:"
    @read -s password && echo "$$password" > {{ vault_file }}
    @chmod 600 {{ vault_file }}
    @echo "✅ Vault 패스워드 파일 생성 완료: {{ vault_file }}"

# 인벤토리 호스트 목록 (기본 정보만)
[group('정보')]
inventory-list:
    @echo "📋 인벤토리 호스트 목록..."
    uv run ansible-inventory --list -i {{ inventory }}
