# Go MSA ì„œë¹„ìŠ¤ ê´€ë¦¬ Makefile

.PHONY: help build build-api-gateway build-auth-service build-business-service
.PHONY: run run-api-gateway run-auth-service run-business-service
.PHONY: test test-api-gateway test-auth-service test-business-service
.PHONY: tidy tidy-pkg tidy-api-gateway tidy-auth-service tidy-business-service
.PHONY: clean dev-init fmt lint status ps
.PHONY: stop stop-auth stop-business stop-gateway restart dev

# ê¸°ë³¸ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ (ìë™ ì¶”ì¶œ)
help: ## ê¸°ë³¸:ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ í‘œì‹œ
	@echo "ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "; last_cat=""} {split($$2, parts, ":"); cat=parts[1]; desc=parts[2]; if(cat != last_cat) {print "\n\033[33m" cat ":\033[0m"; last_cat=cat} printf "  \033[36m%-25s\033[0m %s\n", $$1, desc}'

# ====================[ Build ]====================
build: ## ë¹Œë“œ:ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ
	@echo "ğŸ”¨ Go Workspace ë¹Œë“œ ì¤‘..."
	go work sync
	go build -o .bin/api-gateway ./api-gateway/cmd/api
	go build -o .bin/auth-service ./services/auth/cmd/api
	go build -o .bin/business-service ./services/business/cmd/api
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

# API Gateway ë¹Œë“œ
build-api-gateway: ## ë¹Œë“œ:API Gateway ë¹Œë“œ
	@echo "ğŸ”¨ API Gateway ë¹Œë“œ ì¤‘..."
	go build -o .bin/api-gateway ./api-gateway/cmd/api
	@echo "âœ… API Gateway ë¹Œë“œ ì™„ë£Œ"

# Auth Service ë¹Œë“œ
build-auth-service: ## ë¹Œë“œ:Auth Service ë¹Œë“œ
	@echo "ğŸ”¨ Auth Service ë¹Œë“œ ì¤‘..."
	go build -o .bin/auth-service ./services/auth/cmd/api
	@echo "âœ… Auth Service ë¹Œë“œ ì™„ë£Œ"

# Business Service ë¹Œë“œ
build-business-service: ## ë¹Œë“œ:Business Service ë¹Œë“œ
	@echo "ğŸ”¨ Business Service ë¹Œë“œ ì¤‘..."
	go build -o .bin/business-service ./services/business/cmd/api
	@echo "âœ… Business Service ë¹Œë“œ ì™„ë£Œ"

# ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
run: ## ì‹¤í–‰:ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
	@echo "ğŸš€ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰ ì¤‘..."
	$(MAKE) run-auth-service &
	sleep 2
	$(MAKE) run-business-service &
	sleep 2
	$(MAKE) run-api-gateway &
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰ ì™„ë£Œ (ë°±ê·¸ë¼ìš´ë“œ)"

# API Gateway ì‹¤í–‰
run-api-gateway: ## ì‹¤í–‰:API Gateway ì‹¤í–‰
	@echo "ğŸš€ API Gateway ì‹¤í–‰ ì¤‘... (í¬íŠ¸ 8080)"
	cd api-gateway && export $$(cat .env | xargs) && go run cmd/api/main.go

# Auth Service ì‹¤í–‰
run-auth-service: ## ì‹¤í–‰:Auth Service ì‹¤í–‰
	@echo "ğŸš€ Auth Service ì‹¤í–‰ ì¤‘... (í¬íŠ¸ 8081)"
	cd services/auth && export $$(cat .env | xargs) && go run cmd/api/main.go

# Business Service ì‹¤í–‰
run-business-service: ## ì‹¤í–‰:Business Service ì‹¤í–‰
	@echo "ğŸš€ Business Service ì‹¤í–‰ ì¤‘... (í¬íŠ¸ 8082)"
	cd services/business && export $$(cat .env | xargs) && go run cmd/api/main.go

# ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ
stop: ## ì¢…ë£Œ:ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ
	@echo "ğŸ›‘ ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘..."
	-lsof -ti:8081 | xargs -r kill -9 || echo "Auth Service (8081) ì—†ìŒ"
	-lsof -ti:8082 | xargs -r kill -9 || echo "Business Service (8082) ì—†ìŒ"
	-lsof -ti:8080 | xargs -r kill -9 || echo "API Gateway (8080) ì—†ìŒ"
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"

# ëª¨ë“  ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
test: ## í…ŒìŠ¤íŠ¸:ëª¨ë“  ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸
	@echo "ğŸ§ª Go Workspace í…ŒìŠ¤íŠ¸ ì¤‘..."
	go test ./...
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

# API Gateway í…ŒìŠ¤íŠ¸
test-api-gateway: ## í…ŒìŠ¤íŠ¸:API Gateway í…ŒìŠ¤íŠ¸
	@echo "ğŸ§ª API Gateway í…ŒìŠ¤íŠ¸ ì¤‘..."
	go test ./api-gateway/...

# Auth Service í…ŒìŠ¤íŠ¸
test-auth-service: ## í…ŒìŠ¤íŠ¸:Auth Service í…ŒìŠ¤íŠ¸
	@echo "ğŸ§ª Auth Service í…ŒìŠ¤íŠ¸ ì¤‘..."
	go test ./services/auth/...

# Business Service í…ŒìŠ¤íŠ¸
test-business-service: ## í…ŒìŠ¤íŠ¸:Business Service í…ŒìŠ¤íŠ¸
	@echo "ğŸ§ª Business Service í…ŒìŠ¤íŠ¸ ì¤‘..."
	go test ./services/business/...

# ëª¨ë“  ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ì •ë¦¬
tidy: ## ì •ë¦¬:ëª¨ë“  ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ì •ë¦¬
	@echo "ğŸ“¦ Go Workspace ì˜ì¡´ì„± ì •ë¦¬ ì¤‘..."
	go work sync
	go mod tidy -C ./pkg
	go mod tidy -C ./api-gateway
	go mod tidy -C ./services/auth
	go mod tidy -C ./services/business
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì˜ì¡´ì„± ì •ë¦¬ ì™„ë£Œ"

# PKG ì˜ì¡´ì„± ì •ë¦¬
tidy-pkg: ## ì •ë¦¬:PKG ì˜ì¡´ì„± ì •ë¦¬
	@echo "ğŸ“¦ pkg ì˜ì¡´ì„± ì •ë¦¬ ì¤‘..."
	go mod tidy -C ./pkg

# API Gateway ì˜ì¡´ì„± ì •ë¦¬
tidy-api-gateway: ## ì •ë¦¬:API Gateway ì˜ì¡´ì„± ì •ë¦¬
	@echo "ğŸ“¦ API Gateway ì˜ì¡´ì„± ì •ë¦¬ ì¤‘..."
	go mod tidy -C ./api-gateway

# Auth Service ì˜ì¡´ì„± ì •ë¦¬
tidy-auth-service: ## ì •ë¦¬:Auth Service ì˜ì¡´ì„± ì •ë¦¬
	@echo "ğŸ“¦ Auth Service ì˜ì¡´ì„± ì •ë¦¬ ì¤‘..."
	go mod tidy -C ./services/auth

# Business Service ì˜ì¡´ì„± ì •ë¦¬
tidy-business-service: ## ì •ë¦¬:Business Service ì˜ì¡´ì„± ì •ë¦¬
	@echo "ğŸ“¦ Business Service ì˜ì¡´ì„± ì •ë¦¬ ì¤‘..."
	go mod tidy -C ./services/business

# ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
clean: ## ì •ë¦¬:ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
	@echo "ğŸ§¹ ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬ ì¤‘..."
	rm -rf .bin/
	@echo "âœ… ì •ë¦¬ ì™„ë£Œ"

# ê°œë°œ í™˜ê²½ ì´ˆê¸°í™”
dev-init: ## ê°œë°œ:ê°œë°œ í™˜ê²½ ì´ˆê¸°í™”
	@echo "ğŸ”§ ê°œë°œ í™˜ê²½ ì´ˆê¸°í™” ì¤‘..."
	$(MAKE) tidy
	$(MAKE) build
	@echo "âœ… ê°œë°œ í™˜ê²½ ì´ˆê¸°í™” ì™„ë£Œ"

# ëª¨ë“  ì„œë¹„ìŠ¤ í˜•ì‹ ê²€ì‚¬
fmt: ## ê°œë°œ:ëª¨ë“  ì„œë¹„ìŠ¤ ì½”ë“œ í¬ë§·íŒ…
	@echo "ğŸ¨ ëª¨ë“  ì„œë¹„ìŠ¤ ì½”ë“œ í¬ë§·íŒ… ì¤‘..."
	cd api-gateway && go fmt ./...
	cd services/auth && go fmt ./...
	cd services/business && go fmt ./...
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì½”ë“œ í¬ë§·íŒ… ì™„ë£Œ"

# ëª¨ë“  ì„œë¹„ìŠ¤ ë¦°íŠ¸ ê²€ì‚¬
lint: ## ê°œë°œ:ëª¨ë“  ì„œë¹„ìŠ¤ ë¦°íŠ¸ ê²€ì‚¬
	@echo "ğŸ” ëª¨ë“  ì„œë¹„ìŠ¤ ë¦°íŠ¸ ê²€ì‚¬ ì¤‘..."
	cd api-gateway && go vet ./...
	cd services/auth && go vet ./...
	cd services/business && go vet ./...
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ë¦°íŠ¸ ê²€ì‚¬ ì™„ë£Œ"

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
status: ## ëª¨ë‹ˆí„°ë§:ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
	@echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
	@echo "API Gateway (8080): $$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "DOWN")"
	@echo "Auth Service (8081): $$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/health || echo "DOWN")"
	@echo "Business Service (8082): $$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8082/health || echo "DOWN")"

# ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ í”„ë¡œì„¸ìŠ¤ í™•ì¸
ps: ## ëª¨ë‹ˆí„°ë§:ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ í”„ë¡œì„¸ìŠ¤ í™•ì¸
	@echo "ğŸ” ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ í¬íŠ¸ ìƒíƒœ:"
	@echo "Auth Service (8081): $$(lsof -ti:8081 > /dev/null && echo "ì‹¤í–‰ ì¤‘" || echo "ì—†ìŒ")"
	@echo "Business Service (8082): $$(lsof -ti:8082 > /dev/null && echo "ì‹¤í–‰ ì¤‘" || echo "ì—†ìŒ")"
	@echo "API Gateway (8080): $$(lsof -ti:8080 > /dev/null && echo "ì‹¤í–‰ ì¤‘" || echo "ì—†ìŒ")"

# íŠ¹ì • ì„œë¹„ìŠ¤ ì¢…ë£Œ
stop-auth: ## ì¢…ë£Œ:Auth Service ì¢…ë£Œ
	@echo "ğŸ›‘ Auth Service ì¢…ë£Œ ì¤‘..."
	-lsof -ti:8081 | xargs -r kill -9 || echo "Auth Service (8081) ì—†ìŒ"
	@echo "âœ… Auth Service ì¢…ë£Œ ì™„ë£Œ"

stop-business: ## ì¢…ë£Œ:Business Service ì¢…ë£Œ
	@echo "ğŸ›‘ Business Service ì¢…ë£Œ ì¤‘..."
	-lsof -ti:8082 | xargs -r kill -9 || echo "Business Service (8082) ì—†ìŒ"
	@echo "âœ… Business Service ì¢…ë£Œ ì™„ë£Œ"

stop-gateway: ## ì¢…ë£Œ:API Gateway ì¢…ë£Œ
	@echo "ğŸ›‘ API Gateway ì¢…ë£Œ ì¤‘..."
	-lsof -ti:8080 | xargs -r kill -9 || echo "API Gateway (8080) ì—†ìŒ"
	@echo "âœ… API Gateway ì¢…ë£Œ ì™„ë£Œ"

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
restart: ## ì¬ì‹œì‘:ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘
	@echo "ğŸ”„ ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
	$(MAKE) stop
	sleep 2
	$(MAKE) run
	@echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ"

# ê°œë°œ ì›Œí¬í”Œë¡œìš° (í¬ë§·íŒ… -> ë¦°íŠ¸ -> í…ŒìŠ¤íŠ¸ -> ë¹Œë“œ)
dev: ## ê°œë°œ:ê°œë°œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ (í¬ë§·íŒ…->ë¦°íŠ¸->í…ŒìŠ¤íŠ¸->ë¹Œë“œ)
	@echo "ğŸš€ ê°œë°œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¤‘..."
	$(MAKE) fmt
	$(MAKE) lint
	$(MAKE) test
	$(MAKE) build
	@echo "âœ… ê°œë°œ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ"

# Flyway
flyway-migrate-auth-service: ## flyway:Auth Service Flyway Migrate
	@echo "ğŸ”¨ Auth Service migration ì¤‘..."
	cd services/auth && export $$(cat .env | xargs) && flyway -locations="filesystem:./db/migration" migrate
	@echo "âœ… Auth Service migration ì™„ë£Œ"

flyway-migrate-business-service: ## flyway:Business Service Flyway Migrate
	@echo "ğŸ”¨ Business Service migration ì¤‘..."
	cd services/business && export $$(cat .env | xargs) && flyway -locations="filesystem:./db/migration" migrate
	@echo "âœ… Business Service migration ì™„ë£Œ"

flyway-info-auth-service: ## flyway:Auth Service Flyway Info
	@echo
	cd services/auth && export $$(cat .env | xargs) && flyway -locations="filesystem:./db/migration" info
	@echo

flyway-info-business-service: ## flyway:Business Service Flyway Info
	@echo
	cd services/business && export $$(cat .env | xargs) && flyway -locations="filesystem:./db/migration" info
	@echo