# Import git-related recipes

import? '.claude.just'
import 'git.just'


# Variables
config_dir := env_var('HOME') + '/.config/just'
global_alias := 'jg'

_default:
    @just --justfile {{justfile()}} --list

# justfile과 *.just 파일들을 글로벌 설정으로 등록
[group('just')]
install:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "🚀 Just 파일들을 글로벌로 등록합니다"
    echo "=================================================="

    CONFIG_DIR="{{ config_dir }}"

    # Shell RC 파일 자동 감지
    if [ -f "$HOME/.zshrc" ]; then
        SHELL_RC="$HOME/.zshrc"
    elif [ -f "$HOME/.bashrc" ]; then
        SHELL_RC="$HOME/.bashrc"
    else
        SHELL_RC="$HOME/.zshrc"
    fi
    SHELL_NAME=$(basename "$SHELL_RC")

    # 1. 설정 디렉토리 생성
    echo ""
    echo "📁 설정 디렉토리 생성 중..."
    if [ ! -d "$CONFIG_DIR" ]; then
        mkdir -p "$CONFIG_DIR"
        echo "✅ 디렉토리 생성: $CONFIG_DIR"
    else
        echo "✅ 디렉토리 이미 존재: $CONFIG_DIR"
    fi

    # 2. justfile과 *.just 파일들 복사 (. 으로 시작하는 파일 제외)
    echo ""
    echo "📋 Just 파일들 복사 중..."
    cp -v justfile "$CONFIG_DIR/"

    # .으로 시작하지 않는 .just 파일만 복사
    for file in *.just; do
        if [ -f "$file" ] && [[ ! "$file" =~ ^\. ]]; then
            cp -v "$file" "$CONFIG_DIR/"
        fi
    done

    echo "✅ 파일 복사 완료!"

    # 3. shell rc 파일에 alias 추가 확인
    echo ""
    echo "🔍 $SHELL_NAME alias 확인 중..."
    ALIAS_NAME="{{ global_alias }}"
    ALIAS_LINE="alias $ALIAS_NAME='just --justfile ~/.config/just/justfile --working-directory .'"

    if [ ! -f "$SHELL_RC" ]; then
        echo "⚠️  ${SHELL_RC} 파일이 없습니다. 생성합니다."
        touch "$SHELL_RC"
    fi

    if grep -q "alias $ALIAS_NAME=" "$SHELL_RC"; then
        echo "✅ alias가 이미 존재합니다 (스킵)"
    else
        echo "" >> "$SHELL_RC"
        echo "# Just command alias" >> "$SHELL_RC"
        echo "$ALIAS_LINE" >> "$SHELL_RC"
        echo "✅ ${SHELL_RC}에 alias 추가 완료!"
        echo ""
        echo "⚠️  다음 명령어로 적용하세요:"
        echo "   source ${SHELL_RC}"
    fi

    # 4. 설치 경로의 justfile에서 레시피 이름 변경
    TARGET_JUSTFILE="$CONFIG_DIR/justfile"
    # install: -> _install: 로 변경
    sed -i.bak 's/^install:$/_install:/' "$TARGET_JUSTFILE"
    # 백업 파일 삭제
    rm -f "$TARGET_JUSTFILE.bak"

    echo ""
    echo "=================================================="
    echo "🎉 글로벌 등록 완료!"
    echo ""
    echo "사용법:"
    echo "  $ALIAS_NAME <recipe>        # 어디서든 실행 가능"
    echo "  $ALIAS_NAME --list          # 사용 가능한 레시피 목록"

# 글로벌 설정 제거
[group('just')]
_uninstall:
    #!/usr/bin/env bash
    set -euo pipefail

    echo "🗑️  글로벌 Just 설정을 제거합니다"
    echo "=================================================="

    CONFIG_DIR="{{ config_dir }}"

    # Shell RC 파일 자동 감지
    if [ -f "$HOME/.zshrc" ]; then
        SHELL_RC="$HOME/.zshrc"
    elif [ -f "$HOME/.bashrc" ]; then
        SHELL_RC="$HOME/.bashrc"
    else
        SHELL_RC="$HOME/.zshrc"
    fi
    SHELL_NAME=$(basename "$SHELL_RC")

    # 1. 설정 디렉토리 삭제
    echo ""
    echo "📁 설정 디렉토리 삭제 중..."
    if [ -d "$CONFIG_DIR" ]; then
        rm -rf "$CONFIG_DIR"
        echo "✅ 디렉토리 삭제 완료: $CONFIG_DIR"
    else
        echo "ℹ️  디렉토리가 존재하지 않습니다"
    fi

    # 2. shell rc 파일에서 alias 제거
    echo ""
    echo "🔍 $SHELL_NAME alias 제거 중..."
    ALIAS_NAME="{{ global_alias }}"
    if [ -f "$SHELL_RC" ]; then
        # alias 라인과 주석 제거
        sed -i.bak '/# Just command alias/d; /alias '"$ALIAS_NAME"'=/d' "$SHELL_RC"
        echo "✅ alias 제거 완료!"
        echo ""
        echo "⚠️  다음 명령어로 적용하세요:"
        echo "   source ${SHELL_RC}"
    else
        echo "ℹ️  ${SHELL_RC} 파일이 존재하지 않습니다"
    fi

    echo ""
    echo "=================================================="
    echo "🎉 제거 완료!"
